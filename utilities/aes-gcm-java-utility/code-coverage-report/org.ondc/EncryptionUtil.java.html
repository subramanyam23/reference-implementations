<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EncryptionUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">encryption_util</a> &gt; <a href="index.source.html" class="el_package">org.ondc</a> &gt; <span class="el_source">EncryptionUtil.java</span></div><h1>EncryptionUtil.java</h1><pre class="source lang-java linenums">package org.ondc;

import java.security.SecureRandom;
import java.util.Arrays;
import java.util.Base64;
import java.util.logging.Level;
import java.util.logging.Logger;

import javax.crypto.Cipher;
import javax.crypto.SecretKey;
import javax.crypto.spec.GCMParameterSpec;
import javax.crypto.spec.SecretKeySpec;

import com.google.gson.Gson;
import com.google.gson.annotations.SerializedName;


/**
 * Utility class for encrypting and decrypting payload.
 */
public class EncryptionUtil {
<span class="fc" id="L22">	private static Logger log = Logger.getLogger(&quot;ErrorLogger&quot;);</span>

    private EncryptionUtil() {
        
    }
	/**
	 * The standard Initialization Vector (IV) length (96 bits).
	 */
	public static final int IV_BIT_LENGTH = 96;
	
	/**
	 * The standard authentication tag length (128 bits).
	 */
<span class="fc" id="L35">    public static final int AUTH_TAG_BIT_LENGTH = 128;</span>
    
    
    /**
     * 
     * The POJO class for Encrypted Data.
     *
     */
<span class="fc" id="L43">    public static class EncryptionPayload {</span>
        
        /**
         * The Nonce / IV (Initialization Vector) created for encrypting the data.
         */
        private String nonce;
        
    	/**
    	 * The Encrypted Data in base64 encoded format.
    	 */
        @SerializedName(&quot;encrypted_data&quot;)
        private String encrypedData;
        
        /**
         * The HMAC
         */
        private String hmac;

        /**
         * Gets the Encrypted Data
         * @return The Encrypted Data.
         */
        public String getEncrypedData() {
<span class="fc" id="L66">            return encrypedData;</span>
        }

        /**
         * Sets the Encrypted Data.
         * @param encrypedData The Encrypted Data.
         */
        private void setEncrypedData(String encrypedData) {
<span class="fc" id="L74">            this.encrypedData = encrypedData;</span>
<span class="fc" id="L75">        }</span>

        /**
         * Gets the Nonce.
         * @return The Nonce.
         */
        public String getNonce() {
<span class="fc" id="L82">            return nonce;</span>
        }

        /**
         * Sets the Nonce.
         * @param nonce The Nonce.
         */
        private void setNonce(String nonce) {
<span class="fc" id="L90">            this.nonce = nonce;</span>
<span class="fc" id="L91">        }</span>

        /**
         * Gets the HMAC.
         * @return The HMAC.
         */
        public String getHmac() {
<span class="fc" id="L98">            return hmac;</span>
        }

        /**
         * Sets the HMAC.
         * @param hmac The HMAC.
         */
        private void setHmac(String hmac) {
<span class="fc" id="L106">            this.hmac = hmac;</span>
<span class="fc" id="L107">        }</span>

        /**
         * A Method to convert this instance of a class to base64 string.
         * @return Base64 Encoded string of the object.
         */
        public String toBase64String() {
<span class="fc" id="L114">            return bytesToString(new Gson().toJson(this).getBytes());</span>
        }

    }

    /**
     * Encrypts the specified plain text using AES/GCM/NoPadding.
     * @param key The Shared Key.
     * @param data The Raw Data to be Encrypted.
     * @return The Encrypted data in base64 encoded format.
     */
    public static String encryptData(String key, String data) {
    	
    	// Initialize a EncryptionPayload Object.
<span class="fc" id="L128">        String enryptionPayload = null;</span>
        try {
        	
        	// Create a Cipher instance.
<span class="fc" id="L132">            Cipher cipher = Cipher.getInstance(&quot;AES/GCM/NoPadding&quot;);</span>
            
            // De-serializing the Shared Key.
<span class="fc" id="L135">            SecretKey sKey = KeyUtil.sharedKeyFromString(key);</span>
<span class="fc" id="L136">            SecretKeySpec keySpec = new SecretKeySpec(sKey.getEncoded(), &quot;AES&quot;);</span>
            
            // Randomly generate the IV / nonce.
<span class="fc" id="L139">            SecureRandom secureRandom = new SecureRandom();</span>
<span class="fc" id="L140">            byte[] iv = new byte[IV_BIT_LENGTH / 8];</span>
<span class="fc" id="L141">            secureRandom.nextBytes(iv);</span>
            
            // Initialize AES/GCM cipher for encryption
<span class="fc" id="L144">            cipher.init(Cipher.ENCRYPT_MODE, keySpec, new GCMParameterSpec(AUTH_TAG_BIT_LENGTH, iv));</span>
            
            // Encrypt the raw data and get the cipher text and authentication tag.
<span class="fc" id="L147">            byte[] eData = cipher.doFinal(data.getBytes());</span>
<span class="fc" id="L148">            EncryptionPayload encryptedData = new EncryptionPayload();</span>
<span class="fc" id="L149">            int tagLengthBytes = AUTH_TAG_BIT_LENGTH / Byte.SIZE;</span>
            
            
<span class="fc" id="L152">            byte[] encryptedText=Arrays.copyOfRange(eData, 0, eData.length - tagLengthBytes);</span>
<span class="fc" id="L153">            byte[] authTag= Arrays.copyOfRange(eData, eData.length - tagLengthBytes, eData.length);</span>
           
            // Set the values for the EncryptedData object.
<span class="fc" id="L156">            encryptedData.setEncrypedData(bytesToString(encryptedText));</span>
<span class="fc" id="L157">            encryptedData.setNonce(bytesToString(iv));</span>
<span class="fc" id="L158">            encryptedData.setHmac(bytesToString(authTag)); </span>
            
<span class="fc" id="L160">            enryptionPayload = encryptedData.toBase64String();</span>
<span class="pc" id="L161">        } catch (Exception e) {</span>
<span class="nc" id="L162">            log.log(Level.SEVERE, e.getMessage(), e);</span>
        }
        
        // Return the Encrypted Data.
<span class="fc" id="L166">        return enryptionPayload;</span>
    }

    /**
     * Decrypts the Encrypted Data using Shared Key.
     * @param key The Shared Key.
     * @param eData The Encrypted Data.
     * @return The Raw Decrypted data.
     */
    public static String decryptData(String key, String eData) {
    	
    	// Initialize a variable to store Decrypted Data.
<span class="fc" id="L178">        String rawData = null;</span>
        
        // Decode the base64 string and De-serialize it as› EncryptionPayload Object.
<span class="fc" id="L181">        String json = stringToBytes(eData);</span>
<span class="fc" id="L182">        EncryptionPayload encryptedData = new Gson().fromJson(json, EncryptionPayload.class);</span>
        
        try {
        	
        	// Create a Cipher instance.
<span class="fc" id="L187">            Cipher cipher = Cipher.getInstance(&quot;AES/GCM/NoPadding&quot;);</span>
            
            // Decode the fields of encryptedData from base64 to bytes.
<span class="fc" id="L190">            byte[] nonce = Base64.getDecoder().decode(encryptedData.getNonce());</span>
<span class="fc" id="L191">            byte[] authTagBytes = Base64.getDecoder().decode(encryptedData.getHmac());</span>
<span class="fc" id="L192">            byte[] eBytes = Base64.getDecoder().decode(encryptedData.getEncrypedData());</span>
            
<span class="fc" id="L194">            byte[] encryptedBytes= Arrays.copyOf(eBytes, eBytes.length + authTagBytes.length);</span>
<span class="fc" id="L195">            System.arraycopy(authTagBytes,0,encryptedBytes,eBytes.length,authTagBytes.length);</span>
            
            // De-serialize the Shared Key.
<span class="fc" id="L198">            SecretKey sKey = KeyUtil.sharedKeyFromString(key);</span>
<span class="fc" id="L199">            SecretKeySpec keySpec = new SecretKeySpec(sKey.getEncoded(), &quot;AES&quot;);</span>
            
            // Initialize the AES/GCM Cipher instance for decryption.
<span class="fc" id="L202">            cipher.init(Cipher.DECRYPT_MODE, keySpec, new GCMParameterSpec(128, nonce));</span>
            
            
            // Decrypt the data
<span class="fc" id="L206">            byte[] dData = cipher.doFinal(encryptedBytes);</span>
<span class="fc" id="L207">            rawData = new String(dData);</span>
            
<span class="fc" id="L209">        } catch (Exception e) {</span>
<span class="fc" id="L210">            log.log(Level.SEVERE, e.getMessage(), e);</span>
        }
        
        // Return the Decrypted Data.›
<span class="fc" id="L214">        return rawData;</span>
        
    }
    

    /**
     * Converts a Byte Array into base64 string.
     * @param bytes The Byte Array to be encoded.
     * @return The base64 encoded string.
     */
    private static String bytesToString(byte[] bytes) {
<span class="fc" id="L225">        return Base64.getEncoder().encodeToString(bytes);</span>
    }
    
    
    /**
     * Converts a base64 string into Byte Array.
     * @param data The base64 encoded string.
     * @return The decoded Byte Array.
     */
    private static String stringToBytes(String data) {
<span class="fc" id="L235">    	byte[] bytes = Base64.getDecoder().decode(data);</span>
<span class="fc" id="L236">    	return new String(bytes);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>