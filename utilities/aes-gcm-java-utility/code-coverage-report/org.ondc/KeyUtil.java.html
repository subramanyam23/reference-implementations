<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>KeyUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">encryption_util</a> &gt; <a href="index.source.html" class="el_package">org.ondc</a> &gt; <span class="el_source">KeyUtil.java</span></div><h1>KeyUtil.java</h1><pre class="source lang-java linenums">package org.ondc;

import java.security.Key;
import java.security.KeyFactory;
import java.security.KeyPair;
import java.security.KeyPairGenerator;
import java.security.NoSuchAlgorithmException;
import java.security.PrivateKey;
import java.security.PublicKey;
import java.security.spec.InvalidKeySpecException;
import java.security.spec.PKCS8EncodedKeySpec;
import java.security.spec.X509EncodedKeySpec;
import java.util.Base64;
import java.util.logging.Level;
import java.util.logging.Logger;

import javax.crypto.KeyAgreement;
import javax.crypto.SecretKey;
import javax.crypto.spec.SecretKeySpec;

/**
 * 
 * Utility Class to Generate Keypairs and Shared Key.
 *
 */
public class KeyUtil {
<span class="fc" id="L27">	private static Logger log = Logger.getLogger(&quot;ErrorLogger&quot;);</span>

    private KeyUtil() {

    }

    /**
     * The Algorithm used to generate Key pairs. (&quot;X25519&quot;).
     */
<span class="fc" id="L36">    public static final String KEYPAIR_GENERATION_ALGORITHM = &quot;X25519&quot;;</span>
	
	/**
	 * 
	 * POJO class for storing private and public keys.
	 *
	 */
    public static class DHKeyPair {
    	
    	/**
    	 * The Public Key.
    	 */
        private String publicKey;
        
        /**
         * The Private Key.
         */
        private String privateKey;

        /**
         * Constructor
         * @param keyPair Instance of java.security.KeyPair Class.
         */
<span class="fc" id="L59">        public DHKeyPair(KeyPair keyPair) {</span>
<span class="fc" id="L60">            this.publicKey = keyToString(keyPair.getPublic());</span>
<span class="fc" id="L61">            this.privateKey = keyToString(keyPair.getPrivate());</span>
<span class="fc" id="L62">        }</span>

        /**
         * Gets the Public Key.
         * @return Public Key.
         */
        public String getPublicKey() {
<span class="fc" id="L69">            return publicKey;</span>
        }

        /**
         * Gets the Private Key.
         * @return Private Key.
         */
        public String getPrivateKey() {
<span class="fc" id="L77">            return privateKey;</span>
        }
        
        /**
         * String Formatting.
         */
        @Override
        public String toString() {
<span class="nc" id="L85">            return &quot;DHKeyPair [publicKey=&quot; + publicKey + &quot;, privateKey=&quot; + privateKey + &quot;]&quot;;</span>
        }
        

    }

    /**
     * Generate a Keypair.
     * @return Generated Keypair.
     */
    public static DHKeyPair generateKeyPair() {
<span class="fc" id="L96">        DHKeyPair generatedKeyPair = null;</span>
        try {
<span class="fc" id="L98">            KeyPair keyPair = KeyPairGenerator.getInstance(KEYPAIR_GENERATION_ALGORITHM).generateKeyPair();</span>
<span class="fc" id="L99">            generatedKeyPair = new DHKeyPair(keyPair);</span>
<span class="pc" id="L100">        } catch (Exception e) {</span>
<span class="nc" id="L101">            log.log(Level.SEVERE, e.getMessage(), e);</span>
        }
<span class="fc" id="L103">        return generatedKeyPair;</span>
    }

    /**
     * Generates a SharedKey.
     * @param privateKeyStr Private Key of one party.
     * @param publicKeyStr Public Key of the other party.
     * @return Shared key as base64 string.
     */
    public static String generateSharedKey(String privateKeyStr, String publicKeyStr){
    	
    	// Initialize the variables to store Shared Key and Key Agreement.
<span class="fc" id="L115">        String sharedKey = null;</span>
        KeyAgreement ka;
        
        try {
        	
        	// De-serializing the private key and public key.
<span class="fc" id="L121">            Key privateKey = privateKeyFromString(privateKeyStr);</span>
<span class="fc" id="L122">            Key publicKey = publicKeyFromString(publicKeyStr);</span>
            
            // Intializing a key agreement instance.
<span class="fc" id="L125">            ka = KeyAgreement.getInstance(KEYPAIR_GENERATION_ALGORITHM, &quot;BC&quot;);</span>
<span class="fc" id="L126">            ka.init(privateKey);</span>
            
            // Generate the Shared Key.
<span class="fc" id="L129">            ka.doPhase(publicKey, true);</span>
<span class="fc" id="L130">            SecretKey sKey = ka.generateSecret(&quot;AES&quot;);</span>
<span class="fc" id="L131">            sharedKey = keyToString(sKey);</span>
            
<span class="pc" id="L133">        } catch (Exception e) {</span>
<span class="nc" id="L134">            log.log(Level.SEVERE, e.getMessage(), e);</span>
        }
        
        // Return the Shared Key.
<span class="fc" id="L138">        return sharedKey;</span>
    }

    /**
     * Encode a key to base64 string.
     * @param key The key to encode.
     * @return The Encoded Key.
     */
    private static String keyToString(Key key) {
<span class="fc" id="L147">        byte[] encodedKey = key.getEncoded();</span>
<span class="fc" id="L148">        return Base64.getEncoder().encodeToString(encodedKey);</span>
    }

    /**
     * Get the Public Key from base64 encoded string.
     * @param publicKeyStr The base64 encoded Public Key string.
     * @return The Decoded Public Key.
     * @throws NoSuchAlgorithmException Thrown when invalid keypair generation algorithm is configured.
     * @throws InvalidKeySpecException Thrown if the public key is invalid.
     */
    private static PublicKey publicKeyFromString(String publicKeyStr) throws NoSuchAlgorithmException, InvalidKeySpecException  {
<span class="fc" id="L159">        byte[] encodedKey = Base64.getDecoder().decode(publicKeyStr);</span>
<span class="fc" id="L160">        KeyFactory keyFactory = KeyFactory.getInstance(KEYPAIR_GENERATION_ALGORITHM);</span>
<span class="fc" id="L161">        return keyFactory.generatePublic(new X509EncodedKeySpec(encodedKey));</span>
    }

    /**
     * Get the Private Key from base64 encoded string.
     * @param privateKeyStr The base64 encoded Private Key string.
     * @return The Decoded Private Key.
     * @throws NoSuchAlgorithmException Thrown when invalid keypair generation algorithm is configured.
     * @throws InvalidKeySpecException Thrown if the private key is invalid.
     */
    private static PrivateKey privateKeyFromString(String privateKeyStr) throws NoSuchAlgorithmException, InvalidKeySpecException  {
<span class="fc" id="L172">        byte[] encodedKey = Base64.getDecoder().decode(privateKeyStr);</span>
<span class="fc" id="L173">        KeyFactory keyFactory = KeyFactory.getInstance(KEYPAIR_GENERATION_ALGORITHM);</span>
<span class="fc" id="L174">        return keyFactory.generatePrivate(new PKCS8EncodedKeySpec(encodedKey));</span>
    }

    /**
     * Get the Shared Key from base64 encoded string.
     * @param sharedKeyString The base64 encoded Shared Key String.
     * @return The Decoded Shared Key.
     */
    protected static SecretKey sharedKeyFromString(String sharedKeyString) {
<span class="fc" id="L183">        byte[] decodedKey = Base64.getDecoder().decode(sharedKeyString);</span>
<span class="fc" id="L184">        return new SecretKeySpec(decodedKey, KEYPAIR_GENERATION_ALGORITHM);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>